steps:
  - script: |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=$(ssh_timeout_s) "$(username)"@"$(publicIP)" '
      source /etc/profile.d/deploy_server.sh

      saplib_rg=${{parameters.saplib_rg_name}}
      repo_dir=$HOME/${saplib_rg}/sap-hana
      ws_dir=$HOME/azure_sap_automated_deployment/workspaces/sap_library/${saplib_rg}
      input=${ws_dir}/${saplib_rg}.json

      echo "=== Checkout required branch ${{parameters.branch_name}} ==="
      cd $HOME/${saplib_rg}/sap-hana && git checkout ${{parameters.branch_name}}
      
      echo "=== Enter workspace ${ws_dir} ==="
      cd ${ws_dir}
      terraform plan -var-file=${input} ${repo_dir}/deploy/terraform/bootstrap/sap_library/ > plan_output.log
      cat plan_output.log
      
      if ! grep "No changes" plan_output.log; then exit 1; fi;
      '
    displayName: "Validate deployer new config"
    env:
      ARM_CLIENT_ID: $(hana-pipeline-spn-id)
      ARM_CLIENT_SECRET: $(hana-pipeline-spn-pw)
      ARM_TENANT_ID: $(landscape-tenant)
      ARM_SUBSCRIPTION_ID: $(landscape-subscription)
