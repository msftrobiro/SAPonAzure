#!/bin/bash

function main(){
    
    validate_deployer_tfstate
}

function validate_deployer_tfstate(){

    echo "Check if terraform.tfstate of deployer exists:"

    if [ ! -f "${deployer_terraform_tfstate_path}" ]; then
        echo "${deployer_terraform_tfstate_path} does not exist."
        exit 2
    else 
        echo "${deployer_terraform_tfstate_path} exists."
        deployer_remote_backend_init
    fi
}

function deployer_remote_backend_init(){

    echo "Start initialize remote backend for deployer"

    cp ${deployer_terraform_tfstate_path} ../

    cd ..

    terraform init -force-copy \
    -backend-config "resource_group_name=${saplibrary-resource-group}" \
    -backend-config "storage_account_name=${tfstate-storage-account-name}" \
    -backend-config "container_name=deployer" \
    -backend-config "key=deployer.terraform.tfstate"

    terraform state push "deployer.terraform.tfstate"
}

main "$@"
